<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ç´„æ•°åˆ¤å®šã‚¢ãƒ—ãƒª</title>
<style>
  :root{
    --bg:#f9fafb; --ink:#111; --muted:#6b7280;
    --dot:#60a5fa; --plate:#fff9db; --ok:#16a34a; --ng:#ef4444;
    --shadow: inset 0 0 8px rgba(0,0,0,.18);
    --dur: 250ms; /* å‹•çš„ã«JSã‹ã‚‰ä¸Šæ›¸ãï¼ˆå„é…å¸ƒã§èª¿æ•´ï¼‰ */
  }
  body{font-family:"Rounded Mplus 1c","Hiragino Maru Gothic ProN",system-ui,sans-serif;background:var(--bg);margin:20px;text-align:center;color:var(--ink);}
  input,button{font-size:18px;padding:8px 14px;margin:6px;border-radius:12px;border:1px solid #d1d5db;background:#fff}
  button:disabled{opacity:.5;pointer-events:none}
  #buttons{margin:8px 0}
  .numBtn{min-width:42px; transition:background-color .2s ease, color .2s ease, border-color .2s ease;}
  .mark-ok{ background:#dcfce7; color:#065f46; border-color:#86efac; }
  .mark-ng{ background:#fee2e2; color:#7f1d1d; border-color:#fca5a5; }
  #dots{margin:10px 0;display:flex;flex-wrap:wrap;justify-content:center}
  .dot, .flyer{
    width:20px;height:20px;border-radius:50%;background:var(--dot);display:inline-block;margin:3px;
    transition:opacity .25s ease;
  }
  .flyer{
    position:fixed; z-index:9999;
    box-shadow:0 2px 10px rgba(0,0,0,.15);
    will-change:left, top;
    transition:left var(--dur) ease, top var(--dur) ease;
  }
  .plateArea{display:flex;justify-content:center;flex-wrap:wrap;margin:12px 0}
  .plate{
    width:92px;height:92px;border-radius:50%;
    background:var(--plate);border:2px solid #e5e7eb;box-shadow:var(--shadow);
    margin:10px;display:flex;flex-wrap:wrap;justify-content:center;align-items:center;position:relative;
  }
  #result{font-size:22px;font-weight:700;margin-top:10px}
  #formula{font-size:18px;color:#374151;margin-top:6px}

  /* ç›®ç«‹ã¤ã€Œç´„æ•°ã‹ãªï¼Ÿã€ãƒœã‚¿ãƒ³ */
  #checkBtn{
    font-size:20px;
    padding:12px 20px;
    border-radius:14px;
    background:linear-gradient(180deg,#22c55e,#16a34a);
    color:#fff;
    border:none;
    box-shadow:0 8px 20px rgba(22,163,74,.35);
    position:sticky;
    top:8px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚è¦‹å¤±ã„ã«ãã„ */
    z-index:10;
    animation:pulse 1.6s ease-in-out infinite;
  }
  #checkBtn:active{ transform:translateY(1px); }
  @keyframes pulse{
    0%,100%{ box-shadow:0 8px 20px rgba(22,163,74,.35); transform:scale(1); }
    50%{ box-shadow:0 12px 26px rgba(22,163,74,.5); transform:scale(1.02); }
  }
</style>
</head>
<body>
  <h2>ç´„æ•°åˆ¤å®šã‚¢ãƒ—ãƒª</h2>
  <p>æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
  <input type="number" id="numberInput" min="1" />

  <div id="buttons"></div>
  <div id="dots"></div>
  <div class="plateArea" id="plates"></div>
  <button id="checkBtn" onclick="checkDivisor()" style="display:none;">ç´„æ•°ã‹ãªï¼Ÿ</button>
  <div id="result"></div>
  <div id="formula"></div>

<script>
let currentNumber = 0;
let selectedDivisor = 0;
let distributing = false;
let genTimer = null;

const TOTAL_ANIM_MS = 3000; // â˜… ç·ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ï¼å¸¸ã«3ç§’

function $(sel){ return document.querySelector(sel); }
function $all(sel){ return Array.from(document.querySelectorAll(sel)); }

// å…ƒã®ä½ç½®ã®ãƒ‰ãƒƒãƒˆã‚’å†è¡¨ç¤ºï¼‹ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼æƒé™¤
function resetDots(){
  $all("#dots .dot").forEach(d=>{ d.style.opacity = "1"; });
  $all(".flyer").forEach(f=>f.remove());
}

// å…¥åŠ›ã®ãŸã³ã«è‡ªå‹•ç”Ÿæˆï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
$("#numberInput").addEventListener("input", () => {
  if (genTimer) clearTimeout(genTimer);
  genTimer = setTimeout(generate, 180);
});

function generate(){
  if(distributing) return; // é…å¸ƒä¸­ã¯ç”Ÿæˆã—ãªã„
  const n = parseInt($("#numberInput").value);
  if(!n || n<1) {
    // ã‚¯ãƒªã‚¢
    $("#buttons").innerHTML = "";
    $("#dots").innerHTML = "";
    $("#plates").innerHTML = "";
    $("#result").textContent = "";
    $("#formula").textContent = "";
    $("#checkBtn").style.display = "none";
    return;
  }
  currentNumber = n;
  selectedDivisor = 0;

  // åˆæœŸåŒ–
  $("#buttons").innerHTML = "";
  $("#dots").innerHTML = "";
  $("#plates").innerHTML = "";
  $("#result").textContent = "";
  $("#formula").textContent = "";
  $("#checkBtn").style.display = "none";
  resetDots();

  // ãƒ‰ãƒƒãƒˆç”Ÿæˆ
  const dotsWrap = $("#dots");
  for(let i=0;i<n;i++){
    const d = document.createElement("div");
    d.className = "dot";
    dotsWrap.appendChild(d);
  }

  // 1ã€œn ãƒœã‚¿ãƒ³ç”Ÿæˆï¼ˆdata-vã§å€¤ã‚’ä¿æŒï¼‰
  const btnWrap = $("#buttons");
  for(let i=1;i<=n;i++){
    const btn = document.createElement("button");
    btn.className = "numBtn";
    btn.textContent = i;
    btn.dataset.v = String(i);
    btn.onclick = () => selectDivisor(i);
    btnWrap.appendChild(btn);
  }
}

function selectDivisor(divisor){
  if(distributing) return;
  selectedDivisor = divisor;

  // ãƒ‰ãƒƒãƒˆã‚’å¿…ãšå…ƒã®å ´æ‰€ã§å¯è¦–ã«
  resetDots();

  const area = $("#plates");
  area.innerHTML = "";
  for(let i=0;i<divisor;i++){
    const p = document.createElement("div");
    p.className = "plate";
    area.appendChild(p);
  }
  $("#checkBtn").style.display = "inline-block";
  $("#result").textContent = "";
  $("#formula").textContent = "";
}

async function checkDivisor(){
  if(selectedDivisor===0 || distributing) return;

  distributing = true;

  // æ“ä½œãƒ­ãƒƒã‚¯ï¼ˆæ•°å­—ãƒœã‚¿ãƒ³ã¯è‰²åˆ†ã‘ã®ãŸã‚æœ‰åŠ¹ã®ã¾ã¾ã§ã‚‚è‰¯ã„ãŒèª¤æ“ä½œé˜²æ­¢ã§ç„¡åŠ¹åŒ–ï¼‰
  $("#checkBtn").disabled = true;
  $all(".numBtn").forEach(b=>b.disabled=true);

  const plates = $all(".plate");
  const dots   = $all("#dots .dot");
  plates.forEach(p=>p.innerHTML=""); // çš¿ã®ä¸­èº«ã‚¯ãƒªã‚¢
  resetDots(); // å¿µã®ãŸã‚

  const n = dots.length;
  if(n === 0){ finishAfter(false); return; }

  // â˜… ç·ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³3ç§’ã‚’ä¿è¨¼ã™ã‚‹ãŸã‚ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
  // 1) å„ãƒ‰ãƒƒãƒˆã®ã‚¹ã‚¿ãƒ¼ãƒˆé–“éš”ï¼ˆãšã‚‰ã—æ™‚é–“ï¼‰
  const stepDelay = TOTAL_ANIM_MS / n;  // ä¾‹: n=50 â†’ 3000/50 = 60msã”ã¨ã«é£›ã³å§‹ã‚ã‚‹
  // 2) å®Ÿéš›ã®ç§»å‹•æ™‚é–“ï¼ˆçŸ­ã‚ã«ã—ã¦ä½™è£•ã‚’ã‚‚ã£ã¦åˆ°ç€ï¼‰
  const travelMs  = Math.max(120, stepDelay * 0.7); // ã¨ã¦ã‚‚å¤šã„æ™‚ã§ã‚‚æœ€ä½120msç¢ºä¿
  // CSS å¤‰æ•°ã‚’æ›´æ–°ï¼ˆflyerã®transitionã«åæ˜ ï¼‰
  document.documentElement.style.setProperty('--dur', `${travelMs}ms`);

  // 3) ã™ã¹ã¦ã®ãƒ•ãƒ©ã‚¤ãƒˆã‚’ä¸¦åˆ—ã«ã€Œé…å»¶é–‹å§‹ã€ã—ã€æœ€å¾ŒãŒç´„3ç§’ã§çµ‚ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹
  const tasks = dots.map((from, i)=>{
    const plateIndex = i % selectedDivisor;
    const plate = plates[plateIndex];
    return new Promise(res=>{
      setTimeout(()=>{
        flyDotOnce(from, plate, travelMs).then(res);
      }, Math.round(i * stepDelay));
    });
  });

  await Promise.all(tasks); // å…¨ãƒ‰ãƒƒãƒˆç€åœ°ã‚’å¾…ã¤ï¼ˆâ‰’3ç§’ï¼‰

  const isDivisor = (currentNumber % selectedDivisor === 0);
  showResult(isDivisor);

  // æ•°å­—ãƒœã‚¿ãƒ³ã‚’è‰²ä»˜ã‘
  const targetBtn = document.querySelector(`#buttons .numBtn[data-v="${selectedDivisor}"]`);
  if (targetBtn){
    targetBtn.classList.remove("mark-ok","mark-ng");
    targetBtn.classList.add(isDivisor ? "mark-ok" : "mark-ng");
  }

  finishAfter();
}

function finishAfter(){
  $("#checkBtn").disabled = false;
  $all(".numBtn").forEach(b=>b.disabled=false);
  distributing = false;
}

/** å˜ä¸€ãƒ‰ãƒƒãƒˆã‚’ from â†’ plate ã¸é£›ã°ã™ï¼ˆç¢ºå®Ÿã«resolveï¼‰ */
function flyDotOnce(fromEl, plateEl, travelMs){
  return new Promise(async resolve=>{
    await nextFrame();

    // ã‚¹ã‚¿ãƒ¼ãƒˆä¸­å¿ƒåº§æ¨™
    const s = fromEl.getBoundingClientRect();
    const sx = s.left + s.width/2;
    const sy = s.top  + s.height/2;

    // ç€åœ°ç”¨ãƒ‰ãƒƒãƒˆï¼ˆæœ€çµ‚é…ç½®ï¼‰
    const landing = document.createElement("div");
    landing.className = "dot";
    landing.style.opacity = "0";
    plateEl.appendChild(landing);

    await nextFrame(); // DOMåæ˜ ã‚’å¾…ã¤
    const e = landing.getBoundingClientRect();
    const ex = e.left + e.width/2;
    const ey = e.top  + e.height/2;

    // åŒä½ç½®ãªã‚‰å³å®Œäº†
    if (Math.abs(ex - sx) < 0.5 && Math.abs(ey - sy) < 0.5){
      landing.style.opacity = "1";
      fromEl.style.opacity = "0";
      return resolve();
    }

    // ç”»é¢ä¸Šã‚’é£›ã¶ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼
    const flyer = document.createElement("div");
    flyer.className = "flyer";
    flyer.style.left = (sx - 10) + "px";
    flyer.style.top  = (sy - 10) + "px";
    document.body.appendChild(flyer);

    await nextFrame();

    let done = false;
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¿ã‚¤ãƒãƒ¼ï¼ˆtransitionendãŒé£›ã°ãªã„ã‚±ãƒ¼ã‚¹å¯¾ç­–ï¼‰
    const pad = 80;
    const timer = setTimeout(finish, travelMs + pad);

    function finish(){
      if(done) return;
      done = true;
      clearTimeout(timer);
      landing.style.opacity = "1"; // ç€åœ°è¡¨ç¤º
      flyer.remove();
      fromEl.style.opacity = "0";  // å…ƒã®ãƒ‰ãƒƒãƒˆã‚’éš ã™
      resolve();
    }

    flyer.addEventListener("transitionend", finish, {once:true});

    // ã‚´ãƒ¼ãƒ«ã¸ï¼ˆCSSã® --dur ãŒåæ˜ ã•ã‚Œã‚‹ï¼‰
    flyer.style.left = (ex - 10) + "px";
    flyer.style.top  = (ey - 10) + "px";
  });
}

function nextFrame(){
  return new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
}

function showResult(ok){
  const r = $("#result");
  const f = $("#formula");
  const n = currentNumber;
  const d = selectedDivisor;
  const q = Math.floor(n / d);
  const rem = n % d;

  if(ok){
    r.textContent = "ç´„æ•°ğŸ˜€";
    r.style.color = "var(--ok)";
    f.textContent = `${n} Ã· ${d} = ${q}`;
  }else{
    r.textContent = "Not ç´„æ•°ğŸ˜¢";
    r.style.color = "var(--ng)";
    f.textContent = `${n} Ã· ${d} = ${q} â€¦ ã‚ã¾ã‚Š ${rem}`;
  }
}
</script>
</body>
</html>
