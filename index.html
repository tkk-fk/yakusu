<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ç´„æ•°ã‚’æ¢ãã†</title>
<style>
  :root{
    --bg:#f9fafb; --ink:#111; --muted:#6b7280;
    --dot:#60a5fa; --plate:#fff9db; --ok:#16a34a; --ng:#ef4444;
    --shadow: inset 0 0 8px rgba(0,0,0,.18);

    /* å¯å¤‰ã‚µã‚¤ã‚ºï¼ˆJSã§ä¸Šæ›¸ãï¼‰ */
    --dot-size: 20px;          /* ãƒ‰ãƒƒãƒˆã¨ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼ã®ç›´å¾„ */
    --plate-size: 92px;        /* çš¿ã®ç›´å¾„ */
    --btn-min: 56px;           /* æ•°å­—ãƒœã‚¿ãƒ³ã®æœ€å°å¹…ãƒ»é«˜ã• */
    --gap: 10px;

    /* é…å¸ƒ1å€‹ã‚ãŸã‚Šã®ç§»å‹•æ™‚é–“ï¼ˆJSãŒæ›´æ–°ï¼‰ */
    --dur: 250ms;
  }

  *{ box-sizing: border-box; }
  body{
    font-family: "Rounded Mplus 1c","Hiragino Maru Gothic ProN",system-ui,sans-serif;
    background:var(--bg); color:var(--ink);
    margin:0;
    padding:
      calc(env(safe-area-inset-top) + 12px)
      calc(env(safe-area-inset-right) + 12px)
      calc(env(safe-area-inset-bottom) + 16px)
      calc(env(safe-area-inset-left) + 12px);
  }

  h2{ margin: 0 0 8px; text-align: center; }
  .topbar{
    display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:10px;
    margin: 6px auto 8px; max-width: 1100px;
  }
  input{
    font-size:18px; padding:10px 14px; border-radius:12px; border:1px solid #d1d5db; background:#fff;
    width: min(380px, 80vw);
  }

  /* ç›®ç«‹ã¤ã€Œç´„æ•°ã‹ãªï¼Ÿã€ãƒœã‚¿ãƒ³ï¼ˆä¸Šéƒ¨ã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼ï¼‰ */
  #checkBtn{
    font-size: clamp(18px, 2.4vw, 20px);
    padding: 12px 20px;
    min-height: 48px;
    border-radius:14px;
    background:linear-gradient(180deg,#22c55e,#16a34a);
    color:#fff; border:none; cursor:pointer;
    box-shadow:0 8px 20px rgba(22,163,74,.35);
    position: sticky; top: 8px; z-index: 20;
    animation:pulse 1.6s ease-in-out infinite;
  }
  #checkBtn:disabled{ opacity:.55; filter: grayscale(.2); }
  @keyframes pulse{
    0%,100%{ box-shadow:0 8px 20px rgba(22,163,74,.35); transform:scale(1); }
    50%{ box-shadow:0 12px 26px rgba(22,163,74,.5); transform:scale(1.02); }
  }

  /* ã‚¨ãƒªã‚¢é…ç½®ï¼šãƒœã‚¿ãƒ³ / ãƒ‰ãƒƒãƒˆ / çš¿ */
  .wrap{
    max-width: 1100px;
    margin: 0 auto;
    display: grid;
    grid-template-rows: auto auto 1fr auto auto;
    gap: 10px;
  }

  /* æ•°å­—ãƒœã‚¿ãƒ³ï¼šè‡ªå‹•ã‚°ãƒªãƒƒãƒ‰ï¼ˆå¤§ãã„ã‚¿ãƒƒãƒ—é ˜åŸŸï¼‰ */
  #buttons{
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(var(--btn-min), 1fr));
    gap: 8px;
  }
  .numBtn{
    min-height: var(--btn-min);
    min-width: var(--btn-min);
    font-size: clamp(16px, 2.2vw, 18px);
    border-radius: 14px;
    border:1px solid #d1d5db;
    background:#fff;
    transition: background-color .2s ease, color .2s ease, border-color .2s ease, transform .05s ease;
    touch-action: manipulation;
  }
  .numBtn:active{ transform: translateY(1px); }
  .mark-ok{ background:#dcfce7; color:#065f46; border-color:#86efac; }
  .mark-ng{ background:#fee2e2; color:#7f1d1d; border-color:#fca5a5; }

  /* ãƒ‰ãƒƒãƒˆã‚¨ãƒªã‚¢ï¼šå†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  #dots{
    display:flex; flex-wrap:wrap; justify-content:center; gap: calc(var(--dot-size) * 0.2);
    max-height: 28vh; overflow: auto; padding: 6px;
    background:#fff; border:1px solid #e5e7eb; border-radius: 12px;
  }
  .dot, .flyer{
    width: var(--dot-size);
    height: var(--dot-size);
    border-radius: 50%;
    background: var(--dot);
  }
  .dot{ transition: opacity .25s ease; }

  /* ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼ï¼šç”»é¢åº§æ¨™ã§ç§»å‹•ï¼ˆå·¦/ä¸Šï¼‰ */
  .flyer{
    position: fixed; z-index: 9999;
    box-shadow:0 2px 10px rgba(0,0,0,.15);
    will-change: left, top;
    transition: left var(--dur) ease, top var(--dur) ease;
  }

  /* çš¿ã‚¨ãƒªã‚¢ï¼šå†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã€æŠ˜è¿”ã— */
  .plateArea{
    display:flex; flex-wrap:wrap; justify-content:center; gap: 12px;
    max-height: 36vh; overflow: auto; padding: 6px;
    background:#fff; border:1px solid #e5e7eb; border-radius: 12px;
  }
  .plate{
    width: var(--plate-size);
    height: var(--plate-size);
    border-radius: 50%;
    background: var(--plate);
    border:2px solid #e5e7eb;
    box-shadow: var(--shadow);
    display:flex; flex-wrap:wrap; justify-content:center; align-items:center;
    position:relative;
  }

  /* çµæœè¡¨ç¤º */
  #result{ font-size: clamp(20px, 2.6vw, 22px); font-weight:700; text-align:center; }
  #formula{ font-size: clamp(16px, 2.2vw, 18px); color:#374151; text-align:center; }

  /* æ¨ªå¹…ãŒåºƒã„ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã€œPCã§ä½™ç™½ã‚’æœ€é©åŒ– */
  @media (min-width: 1024px){
    #dots{ max-height: 30vh; }
    .plateArea{ max-height: 38vh; }
  }
</style>
</head>
<body>
  <h2>ç´„æ•°åˆ¤å®šã‚¢ãƒ—ãƒª</h2>

  <div class="topbar">
    <input type="number" id="numberInput" min="1" placeholder="æ•°å­—ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼š100ï¼‰" />
    <button id="checkBtn" onclick="checkDivisor()" style="display:none;">ç´„æ•°ã‹ãªï¼Ÿ</button>
  </div>

  <div class="wrap">
    <div id="buttons"></div>
    <div id="dots"></div>
    <div class="plateArea" id="plates"></div>
    <div id="result"></div>
    <div id="formula"></div>
  </div>

<script>
let currentNumber = 0;
let selectedDivisor = 0;
let distributing = false;
let genTimer = null;

const TOTAL_ANIM_MS = 3000; // â˜… ã„ã¤ã§ã‚‚ç·ã‚¢ãƒ‹ãƒ¡æ™‚é–“ã‚’3ç§’ã«

const $ = sel => document.querySelector(sel);
const $all = sel => Array.from(document.querySelectorAll(sel));

/* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ»ã‚¹ã‚±ãƒ¼ãƒ« =====
   æ•°ãŒå¤§ãã„ã¨ãã¯ãƒ‰ãƒƒãƒˆå°ã•ã‚ã€çš¿ã‚‚å¾®èª¿æ•´ã€‚
   ã¾ãŸã€ã‚¿ãƒƒãƒ—é ˜åŸŸï¼ˆãƒœã‚¿ãƒ³ï¼‰ã‚‚ååˆ†ãªå¤§ãã•ã‚’ç¢ºä¿ã€‚
*/
function setResponsiveSizes(n){
  let dot = 20, plate = 92, btn = 56;
  if (n > 96){ dot = 14; plate = 88; btn = 56; }
  else if (n > 64){ dot = 16; plate = 90; btn = 56; }
  else if (n > 36){ dot = 18; plate = 92; btn = 56; }
  // ä½™ç™½ï¼ˆgapï¼‰ã¯CSSã®æ¯”ç‡ã§OK

  document.documentElement.style.setProperty('--dot-size', `${dot}px`);
  document.documentElement.style.setProperty('--plate-size', `${plate}px`);
  document.documentElement.style.setProperty('--btn-min', `${btn}px`);
}

/* å…ƒã®ä½ç½®ã®ãƒ‰ãƒƒãƒˆã‚’å†è¡¨ç¤ºï¼‹é£›è¡Œä¸­ã®ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼æƒé™¤ */
function resetDots(){
  $all("#dots .dot").forEach(d=>{ d.style.opacity = "1"; });
  $all(".flyer").forEach(f=>f.remove());
}

/* å…¥åŠ›ã®ãŸã³ã«è‡ªå‹•ç”Ÿæˆï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰ */
$("#numberInput").addEventListener("input", () => {
  if (genTimer) clearTimeout(genTimer);
  genTimer = setTimeout(generate, 160);
});

function generate(){
  if(distributing) return; // é…å¸ƒä¸­ã¯ç”Ÿæˆã—ãªã„
  const n = parseInt($("#numberInput").value);
  if(!n || n<1) {
    // ã‚¯ãƒªã‚¢
    $("#buttons").innerHTML = "";
    $("#dots").innerHTML = "";
    $("#plates").innerHTML = "";
    $("#result").textContent = "";
    $("#formula").textContent = "";
    $("#checkBtn").style.display = "none";
    return;
  }
  currentNumber = n;
  selectedDivisor = 0;

  setResponsiveSizes(n);

  // åˆæœŸåŒ–
  $("#buttons").innerHTML = "";
  $("#dots").innerHTML = "";
  $("#plates").innerHTML = "";
  $("#result").textContent = "";
  $("#formula").textContent = "";
  $("#checkBtn").style.display = "none";
  resetDots();

  // ãƒ‰ãƒƒãƒˆç”Ÿæˆ
  const dotsWrap = $("#dots");
  for(let i=0;i<n;i++){
    const d = document.createElement("div");
    d.className = "dot";
    dotsWrap.appendChild(d);
  }

  // 1ã€œn ãƒœã‚¿ãƒ³ç”Ÿæˆï¼ˆdata-vã§å€¤ã‚’ä¿æŒï¼‰
  const btnWrap = $("#buttons");
  for(let i=1;i<=n;i++){
    const btn = document.createElement("button");
    btn.className = "numBtn";
    btn.textContent = i;
    btn.dataset.v = String(i);
    btn.onclick = () => selectDivisor(i);
    btnWrap.appendChild(btn);
  }
}

function selectDivisor(divisor){
  if(distributing) return;
  selectedDivisor = divisor;

  resetDots();

  const area = $("#plates");
  area.innerHTML = "";
  for(let i=0;i<divisor;i++){
    const p = document.createElement("div");
    p.className = "plate";
    area.appendChild(p);
  }
  $("#checkBtn").style.display = "inline-block";
  $("#result").textContent = "";
  $("#formula").textContent = "";
}

async function checkDivisor(){
  if(selectedDivisor===0 || distributing) return;

  distributing = true;

  // èª¤æ“ä½œé˜²æ­¢ï¼ˆæ•°å­—ãƒœã‚¿ãƒ³ã¯è‰²ä»˜ã‘ã®ãŸã‚ç„¡åŠ¹åŒ–ï¼‰
  $("#checkBtn").disabled = true;
  $all(".numBtn").forEach(b=>b.disabled=true);

  const plates = $all(".plate");
  const dots   = $all("#dots .dot");
  plates.forEach(p=>p.innerHTML=""); // çš¿ã®ä¸­èº«ã‚¯ãƒªã‚¢
  resetDots();

  const n = dots.length;
  if(n === 0){ finishAfter(); return; }

  // â˜… ç·ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³3ç§’ã‚’ä¿è¨¼
  const stepDelay = TOTAL_ANIM_MS / n;           // ãšã‚‰ã—é–“éš”
  const travelMs  = Math.max(120, stepDelay*0.7); // å®Ÿç§»å‹•æ™‚é–“ï¼ˆæœ€ä½120msï¼‰
  document.documentElement.style.setProperty('--dur', `${travelMs}ms`);

  const tasks = dots.map((from, i)=>{
    const plateIndex = i % selectedDivisor;
    const plate = plates[plateIndex];
    return new Promise(res=>{
      setTimeout(()=>{
        flyDotOnce(from, plate, travelMs).then(res);
      }, Math.round(i * stepDelay));
    });
  });

  await Promise.all(tasks); // æœ€å¾Œã®ãƒ‰ãƒƒãƒˆãŒâ‰’3ç§’ã§åˆ°ç€

  const isDivisor = (currentNumber % selectedDivisor === 0);
  showResult(isDivisor);

  // æ•°å­—ãƒœã‚¿ãƒ³ã‚’è‰²ä»˜ã‘
  const targetBtn = document.querySelector(`#buttons .numBtn[data-v="${selectedDivisor}"]`);
  if (targetBtn){
    targetBtn.classList.remove("mark-ok","mark-ng");
    targetBtn.classList.add(isDivisor ? "mark-ok" : "mark-ng");
  }

  finishAfter();
}

function finishAfter(){
  $("#checkBtn").disabled = false;
  $all(".numBtn").forEach(b=>b.disabled=false);
  distributing = false;
}

/** å˜ä¸€ãƒ‰ãƒƒãƒˆã‚’ from â†’ plate ã¸é£›ã°ã™ï¼ˆç¢ºå®Ÿã«resolveï¼‰ */
function flyDotOnce(fromEl, plateEl, travelMs){
  return new Promise(async resolve=>{
    await nextFrame();

    // ã‚¹ã‚¿ãƒ¼ãƒˆä¸­å¿ƒåº§æ¨™
    const s = fromEl.getBoundingClientRect();
    const sx = s.left + s.width/2;
    const sy = s.top  + s.height/2;

    // ç€åœ°ç”¨ãƒ‰ãƒƒãƒˆï¼ˆæœ€çµ‚é…ç½®ï¼‰
    const landing = document.createElement("div");
    landing.className = "dot";
    landing.style.opacity = "0";
    plateEl.appendChild(landing);

    await nextFrame(); // DOMåæ˜ ã‚’å¾…ã¤
    const e = landing.getBoundingClientRect();
    const ex = e.left + e.width/2;
    const ey = e.top  + e.height/2;

    // åŒä½ç½®ãªã‚‰å³å®Œäº†
    if (Math.abs(ex - sx) < 0.5 && Math.abs(ey - sy) < 0.5){
      landing.style.opacity = "1";
      fromEl.style.opacity = "0";
      return resolve();
    }

    // ç”»é¢ä¸Šã‚’é£›ã¶ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼
    const flyer = document.createElement("div");
    flyer.className = "flyer";
    // ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼ã®å¤§ãã•ã‚‚ãƒ‰ãƒƒãƒˆã«åˆã‚ã›ã‚‹
    flyer.style.width  = getComputedStyle(document.documentElement).getPropertyValue('--dot-size').trim();
    flyer.style.height = flyer.style.width;
    flyer.style.left = (sx - parseFloat(flyer.style.width)/2) + "px";
    flyer.style.top  = (sy - parseFloat(flyer.style.height)/2) + "px";
    document.body.appendChild(flyer);

    await nextFrame();

    let done = false;
    const pad = 80; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½™è£•
    const timer = setTimeout(finish, travelMs + pad);

    function finish(){
      if(done) return;
      done = true;
      clearTimeout(timer);
      landing.style.opacity = "1"; // ç€åœ°è¡¨ç¤º
      flyer.remove();
      fromEl.style.opacity = "0";  // å…ƒã®ãƒ‰ãƒƒãƒˆã‚’éš ã™
      resolve();
    }

    flyer.addEventListener("transitionend", finish, {once:true});

    // ç›®çš„åœ°ã¸
    const half = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--dot-size'))/2;
    flyer.style.left = (ex - half) + "px";
    flyer.style.top  = (ey - half) + "px";
  });
}

function nextFrame(){
  return new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
}

function showResult(ok){
  const r = $("#result");
  const f = $("#formula");
  const n = currentNumber;
  const d = selectedDivisor;
  const q = Math.floor(n / d);
  const rem = n % d;

  if(ok){
    r.textContent = "ç´„æ•°ğŸ˜€";
    r.style.color = "var(--ok)";
    f.textContent = `${n} Ã· ${d} = ${q}`;
  }else{
    r.textContent = "ç´„æ•°ã§ã¯ãªã„ğŸ˜¢";
    r.style.color = "var(--ng)";
    f.textContent = `${n} Ã· ${d} = ${q} â€¦ ã‚ã¾ã‚Š ${rem}`;
  }
}

// åˆæœŸèµ·å‹•æ™‚ã€å…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
window.addEventListener('load', ()=>{ $("#numberInput")?.focus(); });

</script>
</body>
</html>
